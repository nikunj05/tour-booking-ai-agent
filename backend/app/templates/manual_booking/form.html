{% extends "layout.html" %}

{% block content %}
<section class="content-header px-1">
    <div class="container-fluid">
        <h1>{{ "Edit Manual Tour Booking" if booking else "Manual Tour Booking" }}</h1>
        <hr>
    </div>
</section>

<section class="content">
<div class="container-fluid py-4">
<div class="row justify-content-center">
<div class="col-lg-12">

<form id="manual-booking-form"
      method="post"
      action="{% if booking %}
                {{ request.url_for('manual_booking_update', booking_id=booking.id) }}
              {% else %}
                {{ request.url_for('manual_booking_create') }}
              {% endif %}"
      class="shadow-sm p-4 rounded bg-white border"
      novalidate>



<!-- ================= GUEST DETAILS ================= -->
<h5 class="mb-3 fw-semibold">Guest Details</h5>

<div class="row">
    <div class="col-md-4 mb-3">
        <label class="form-label fw-semibold">Guest Name</label>
        <input type="text"
               name="guest_name"
               class="form-control"
               value="{{ booking.guest_name if booking else '' }}">
    </div>

    <div class="col-md-4 mb-3">
        <label class="form-label fw-semibold">Phone Number</label>
        <input type="text"
               name="phone"
               class="form-control"
               value="{{ booking.phone if booking else '' }}">
    </div>

    <div class="col-md-4 mb-3">
        <label class="form-label fw-semibold">Email</label>
        <input type="email"
               name="email"
               class="form-control"
               value="{{ booking.email if booking else '' }}">
    </div>
</div>

<div class="row">
    <div class="col-md-12 mb-3">
        <label class="form-label fw-semibold">Pickup Location</label>
        <input type="text"
               name="pickup_location"
               class="form-control"
               value="{{ booking.pickup_location if booking else '' }}">
    </div>
</div>

<!-- ================= TOUR DETAILS ================= -->
<h5 class="mt-4 mb-3 fw-semibold">Tour Details</h5>

<div class="row">
    <div class="col-md-6 mb-3">
        <label class="form-label fw-semibold">Tour Package</label>

        <select name="tour_package_id"
                class="form-select select2"
                {% if selected_package %}disabled{% endif %}
                data-placeholder="Search tour package">
            <option value=""></option>

            {% for package in packages %}
            <option value="{{ package.id }}"
                {% if booking and booking.tour_package_id == package.id %}
                    selected
                {% endif %}
                
                {% if selected_package and package.id == selected_package.id %}
                selected
                {% endif %}>
            
                {{ package.title }} - {{ company.currency }} {{ package.price }}
            </option>
            {% endfor %}
        </select>
        {% if selected_package %}
        <input type="hidden" name="tour_package_id" value="{{ selected_package.id }}">
        {% endif %}
    </div>

    <div class="col-md-3 mb-3">
        <label class="form-label fw-semibold">Travel Date</label>
        <input type="date"
               name="travel_date"
               class="form-control"
               value="{{ booking.travel_date if booking else travel_date }}"
               {% if travel_date %}readonly{% endif %}>
    </div>

    <div class="col-md-3 mb-3">
        <label class="form-label fw-semibold">Travel Time</label>
        <input type="time"
               name="travel_time"
               class="form-control"
               value="{{ booking.travel_time if booking else '' }}">
    </div>
</div>

<!-- ================= PAYMENT DETAILS ================= -->
<h5 class="mt-4 mb-3 fw-semibold">Payment Details</h5>

<div class="row">
    <div class="col-md-4 mb-3">
        <label class="form-label fw-semibold">Total Amount</label>
        <input type="number"
               step="0.01"
               name="total_amount"
               class="form-control"
               value="{{ booking.total_amount if booking else '' }}">
    </div>

    <div class="col-md-4 mb-3">
        <label class="form-label fw-semibold">Advance Paid</label>
        <input type="number"
               step="0.01"
               name="advance_amount"
               class="form-control"
               value="{{ booking.advance_amount if booking else 0 }}">
    </div>

    <div class="col-md-4 mb-3">
        <label class="form-label fw-semibold">Remaining Amount</label>
        <input type="number"
               step="0.01"
               name="remaining_amount"
               class="form-control"
               readonly
               value="{{ booking.remaining_amount if booking else '' }}">
    </div>
</div>

<!-- ================= BUTTONS ================= -->
<div class="mt-4">
    <button type="submit" class="btn btn-submit">
        {{ "Update Booking" if booking else "Book Tour" }}
    </button>

    <a href="{{ request.url_for('manual_booking_list') }}"
       class="btn btn-cancel ms-2">
        Cancel
    </a>
</div>

</form>

</div>
</div>
</div>
</section>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function () {

    /* Select2 */
    $('.select2').select2({
        width: '100%',
        allowClear: true,
        placeholder: function(){
            return $(this).data('placeholder');
        }
    });

    /* Validation */
    $("#manual-booking-form").validate({
        rules: {
            guest_name: { required: true },
            phone: { required: true, minlength: 7, maxlength: 15 },
            email: { email: true },
            pickup_location: { required: true },
            tour_package_id: { required: true },
            travel_date: { required: true },
            total_amount: { required: true, number: true },
            advance_amount: { number: true }
        },
        errorElement: "span",
        errorClass: "invalid-feedback",
        highlight: e => $(e).addClass("is-invalid"),
        unhighlight: e => $(e).removeClass("is-invalid"),
        errorPlacement: (error, element) => error.insertAfter(element)
    });

    /* Remaining amount auto calc */
    function calculateRemaining() {
        const total = parseFloat($('[name="total_amount"]').val()) || 0;
        const advance = parseFloat($('[name="advance_amount"]').val()) || 0;
        $('[name="remaining_amount"]').val(Math.max(total - advance, 0).toFixed(2));
    }

    $('[name="total_amount"], [name="advance_amount"]').on("input", calculateRemaining);
});
</script>
{% endblock %}
