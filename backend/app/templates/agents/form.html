{% extends "layout.html" %}

{% block content %}
<section class="content-header px-1">
    <div class="container-fluid">
        <h1>{{ "Edit Agent" if agent else "Create Agent" }}</h1>
        <hr>
    </div>
</section>

<section class="content">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-12">

                    <form
                        id="agent-form"
                        method="post"
                        enctype="multipart/form-data"
                        action="
                            {% if is_my_profile %}
                                {{ url_for('my_profile_update') }}
                            {% elif agent %}
                                {{ url_for('agent_update', agent_id=agent.id) }}
                            {% else %}
                                {{ url_for('agent_create') }}
                            {% endif %}
                        "
                        class="shadow-sm p-4 rounded bg-white border"
                        novalidate
                    >

                {% if is_my_profile %}
                  <div class="raw mb-3">
                      <label class="form-label fw-semibold">Company Logo</label>
                    <div class="profile-picture d-flex" id="uploadTrigger">       
                        <div>

                            <img
                                id="upload-file"
                                src="{{ url_for('static', path='assets/icon/uploadFile.png') }}"
                                {% if agent.logo %}style="display:none"{% endif %}
                            />
                            <input type="file" id="fileInput" name="logo" accept="image/*">
                            <img
                                id="previewImage"
                                src="{% if agent.logo %}{{ url_for('static', path=agent.logo) }}{% endif %}"
                                height="60"
                                width="60"
                                alt="Profile Image"
                                {% if not agent.logo %}style="display:none"{% endif %}
                            >
                        </div>
                    </div>
                </div>
                {% endif %}



                    <!-- Company Name -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Company Name *</label>
                        <input
                            type="text"
                            name="company_name"
                            class="form-control {% if errors.company_name %}is-invalid{% endif %}"
                            value="{{ form.company_name | default(agent.company_name if agent else '') }}"
                        >
                        <span class="invalid-feedback">
                            {{ errors.company_name | default('') }}
                        </span>
                    </div>

                    <!-- Email -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Email *</label>
                        <input
                            type="email"
                            name="email"
                            class="form-control {% if errors.email %}is-invalid{% endif %}"
                            value="{{ form.email | default(agent.user.email if agent else '') }}"
                            {% if agent %}readonly{% endif %}
                        >
                        <span class="invalid-feedback">
                            {{ errors.email | default('') }}
                        </span>
                    </div>

                    <!-- Phone -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Phone</label>
                        <input
                            type="text"
                            name="phone"
                            class="form-control {% if errors.phone %}is-invalid{% endif %}"
                            value="{{ form.phone | default(agent.phone if agent else '') }}"
                        >
                        <span class="invalid-feedback">
                            {{ errors.phone | default('') }}
                        </span>
                    </div>

                {% if agent and not is_my_profile %}
                    <div class="mb-3 admin-only">
                        <label class="form-label fw-semibold">Status</label>
                        <select name="status" class="form-select">
                            <option value="active"
                                {{ 'selected' if agent.status == 'active' }}>
                                Active
                            </option>
                            <option value="inactive"
                                {{ 'selected' if agent.status == 'inactive' }}>
                                Inactive
                            </option>
                        </select>
                    </div>
                    {% endif %}
                    <!-- Buttons -->
                    <div class="mt-4">
                        <button type="submit" class="btn btn-submit">
                            {{ "Update" if agent else "Create" }}
                        </button>
                    </div>

                </form>

            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    
$(document).ready(function () {

    $("#agent-form").validate({
        rules: {
            company_name: {
                required: true,
            },
            email: {
                required: true,
                email: true
            },
            phone: {
                required: true,
                minlength: 10,
                maxlength: 15
            }
        },



        errorElement: "span",
        errorClass: "invalid-feedback",

        highlight: function (element) {
            $(element).addClass("is-invalid");
        },

        unhighlight: function (element) {
            $(element).removeClass("is-invalid");
        },

        errorPlacement: function (error, element) {
            error.insertAfter(element);
        }
    });

    const trigger = document.getElementById("uploadTrigger");
    const fileInput = document.getElementById("fileInput");
    const previewImage = document.getElementById("previewImage");
    const uploadIcon = document.getElementById("upload-file");

    trigger.addEventListener("click", () => {
        fileInput.click();
    });

    fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file || !file.type.startsWith("image/")) return;

        const reader = new FileReader();
        reader.onload = () => {
            previewImage.src = reader.result;
            previewImage.style.display = "block";
            uploadIcon.style.display = "none";
            trigger.classList.add("has-image"); // works if CSS exists
        };
        reader.readAsDataURL(file);
    });

});
</script>
{% endblock %}
